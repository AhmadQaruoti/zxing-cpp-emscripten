<html>
<body>
<script type="text/javascript">
	var Module = {
		onRuntimeInitialized: function() {
			testZXing();
		}
	};
</script>
<script async src="../../build/zxing.js"></script>
<script>

var testZXing = function() {
	var img = new Image;
	img.src = 'Qr-10.png';
	img.onload = function() {

		var width = Math.floor(this.width),
			height = Math.floor(this.height);

		var canvas = document.createElement('canvas');
		canvas.style.display = 'block';
		canvas.width = width;
		canvas.height = height;
		var ctx = canvas.getContext('2d');
		// ctx.rotate(Math.random()*0.1-0.05);
		ctx.drawImage(this, 0, 0, width, height);
		var imageData = ctx.getImageData(0, 0, width, height);
		var idd = imageData.data;
		document.body.appendChild(canvas);

		Module.decode_callback = function(ptr, len, resultIndex, resultCount) {
			var result = new Uint8Array(Module.HEAPU8.buffer, ptr, len);
			window.resultString = String.fromCharCode.apply(null, result);
		};

		var image = Module._resize(width, height);

		for (var i=0, j=0; i<idd.length; i+=4, j++) {
			Module.HEAPU8[image + j] = idd[i];
		}

		var err = Module._decode_qr();

		console.log("error code", err);
		console.log("result", window.resultString);

		for (var k=0; k<50; k++) {
			for (var i=0, j=0; i<idd.length; i+=4, j++) {
				Module.HEAPU8[image + j] = idd[i];
			}
			err = Module._decode_qr();
		}

		console.time("decode QR");
		for (var i=0, j=0; i<idd.length; i+=4, j++) {
			Module.HEAPU8[image + j] = idd[i];
		}
		err = Module._decode_qr();
		console.timeEnd("decode QR");

		console.time("decode any");
		for (var i=0, j=0; i<idd.length; i+=4, j++) {
			Module.HEAPU8[image + j] = idd[i];
		}
		err = Module._decode_any();
		console.timeEnd("decode any");

		console.time("decode multi");
		for (var i=0, j=0; i<idd.length; i+=4, j++) {
			Module.HEAPU8[image + j] = idd[i];
		}
		err = Module._decode_multi();
		console.timeEnd("decode multi");

		document.body.appendChild(document.createTextNode(err ? ("error: "+err) : window.resultString));

	};
};
</script>

</body>
</html>